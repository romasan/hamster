{"version":3,"sources":["pages/test/firebase_subscribe.js"],"names":["firebase","initializeApp","messagingSenderId","window","messaging","Notification","permission","subscribe","document","querySelector","addEventListener","requestPermission","then","getToken","currentToken","_len","arguments","length","a","Array","_key","console","log","sendTokenToServer","warn","setTokenSentToServer","catch","err","fetch","method","credentials","body","JSON","stringify","token","localStorage","setItem"],"mappings":";AAMA,GANAA,SAASC,cAAc,CACtBC,kBAAmB,kBAKhB,iBAAkBC,OAAQ,CAC7B,IAAIC,EAAYJ,SAASI,YAIO,YAA5BC,aAAaC,YAChBC,IAKDC,SAASC,cAAc,cAAcC,iBAAiB,QAAS,WAC9DH,MAIF,SAASA,IAERH,EAAUO,oBACRC,KAAK,WAELR,EAAUS,WACRD,KAAK,SAAUE,GAAoB,IAAAC,IAAAA,EAAAC,UAAAC,OAAHC,EAACC,IAAAA,MAAAJ,EAAAA,EAAAA,EAAAK,EAAAA,GAAAA,EAAAA,EAAAA,EAAAL,EAAAK,IAADF,EAACE,EAAAJ,GAAAA,UAAAI,GACjCC,QAAQC,IAAI,oBAAqB,CAChCR,aAAAA,EACAI,EAAAA,EACAd,UAAAA,IAGGU,EACHS,EAAkBT,IAElBO,QAAQG,KAAK,8BACbC,GAAqB,MAGtBC,MAAM,SAAUC,GAChBN,QAAQG,KAAK,yCAA0CG,GACvDF,GAAqB,OAGvBC,MAAM,SAAUC,GAChBN,QAAQG,KAAK,uDAAwDG,KAKxE,SAASJ,EAAkBT,GAEzBO,QAAQC,IAAI,gCAGZM,MADU,4BACC,CACVC,OAAQ,OACRC,YAAa,UACbC,KAAMC,KAAKC,UAAU,CACpBC,MAAOpB,MAITW,EAAqBX,GAYvB,SAASW,EAAqBX,GAC7BX,OAAOgC,aAAaC,QACnB,6BACAtB,GAA8B","file":"firebase_subscribe.bec06c05.js","sourceRoot":"..","sourcesContent":["firebase.initializeApp({\n\tmessagingSenderId: '1061805458854'\n});\n\n// браузер поддерживает уведомления\n// вообще, эту проверку должна делать библиотека Firebase, но она этого не делает\nif ('Notification' in window) {\n\tvar messaging = firebase.messaging();\n\n\t// пользователь уже разрешил получение уведомлений\n\t// подписываем на уведомления если ещё не подписали\n\tif (Notification.permission === 'granted') {\n\t\tsubscribe();\n\t}\n\n\t// по клику, запрашиваем у пользователя разрешение на уведомления\n\t// и подписываем его\n\tdocument.querySelector('#subscribe').addEventListener('click', function () {\n\t\tsubscribe();\n\t});\n}\n\nfunction subscribe() {\n\t// запрашиваем разрешение на получение уведомлений\n\tmessaging.requestPermission()\n\t\t.then(function () {\n\t\t\t// получаем ID устройства\n\t\t\tmessaging.getToken()\n\t\t\t\t.then(function (currentToken, ...a) {\n\t\t\t\t\tconsole.log('==== currentToken', {\n\t\t\t\t\t\tcurrentToken,\n\t\t\t\t\t\ta,\n\t\t\t\t\t\tmessaging,\n\t\t\t\t\t});\n\n\t\t\t\t\tif (currentToken) {\n\t\t\t\t\t\tsendTokenToServer(currentToken);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn('Не удалось получить токен.');\n\t\t\t\t\t\tsetTokenSentToServer(false);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch(function (err) {\n\t\t\t\t\tconsole.warn('При получении токена произошла ошибка.', err);\n\t\t\t\t\tsetTokenSentToServer(false);\n\t\t\t\t});\n\t\t})\n\t\t.catch(function (err) {\n\t\t\tconsole.warn('Не удалось получить разрешение на показ уведомлений.', err);\n\t\t});\n}\n\n// отправка ID на сервер\nfunction sendTokenToServer(currentToken) {\n\t// if (!isTokenSentToServer(currentToken)) {\n\t\tconsole.log('Отправка токена на сервер...');\n\n\t\tvar url = 'https://w.nbauer.ru/token'; // адрес скрипта на сервере который сохраняет ID устройства\n\t\tfetch(url, {\n\t\t\tmethod: 'POST',\n\t\t\tcredentials: 'include',\n\t\t\tbody: JSON.stringify({\n\t\t\t\ttoken: currentToken\n\t\t\t}),\n\t\t});\n\n\t\tsetTokenSentToServer(currentToken);\n\t// } else {\n\t// \tconsole.log('Токен уже отправлен на сервер.');\n\t// }\n}\n\n// используем localStorage для отметки того,\n// что пользователь уже подписался на уведомления\n// function isTokenSentToServer(currentToken) {\n// \treturn window.localStorage.getItem('sentFirebaseMessagingToken') == currentToken;\n// }\n\nfunction setTokenSentToServer(currentToken) {\n\twindow.localStorage.setItem(\n\t\t'sentFirebaseMessagingToken',\n\t\tcurrentToken ? currentToken : ''\n\t);\n}"]}